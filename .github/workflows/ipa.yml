name: Build iOS Only

on:
  workflow_dispatch: # 允許手動點擊按鈕觸發

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest # 必須使用 macOS 環境
    steps:
      # 1. 下載程式碼
      - uses: actions/checkout@v4
        with:
          ref: master

      # 2. 設定 Flutter 環境 (沿用專案指定的 3.38.x 版本)
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.x"
          cache: true

      # 3. 安裝 Flutter 依賴
      - name: Install Flutter Dependencies
        run: |
          cd simple_live_app
          flutter pub get

      # 4. 安裝 iOS 依賴 (CocoaPods)
      - name: Install CocoaPods
        run: |
          cd simple_live_app/ios
          pod install --repo-update

      # 5. 開始編譯 (跳過簽名，避免報錯)
      - name: Build iOS (No Codesign)
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign

      # 6. 打包成 IPA 檔案
      - name: Pack IPA
        run: |
          cd simple_live_app/build/ios/iphoneos
          mkdir Payload
          # 將 .app 移動到 Payload 資料夾中
          mv Runner.app Payload
          # 壓縮成 .ipa
          zip -q -r simple_live_unsigned.ipa Payload

      # 7. 上傳結果讓你下載
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: simple_live_ios_unsigned
          path: simple_live_app/build/ios/iphoneos/simple_live_unsigned.ipa
          retention-days: 3
